name: pre-test

on:
  push:
    branches:
      - ci-test
  pull_request:
  workflow_dispatch:

env:
  DOO_GITHUB_TOKEN: ${{ secrets.DOO_GITHUB_TOKEN }}
  TEST_TAG: vanderleiromera/doodba16_odoo:test

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.0
      - uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.10.19"
      - uses: pre-commit/action@v3.0.1

  test:
    name: Build and test image
    needs: pre-commit
    runs-on: ubuntu-latest

    services:
      db:
        image: ghcr.io/tecnativa/postgres-autoconf:16-alpine
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoopassword
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6.0.0
        with:
          fetch-depth: 0 # necessário para tagging

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1

      - name: Log in to DockerHub
        uses: docker/login-action@v3.6.0
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Bump version and push tag
        id: tagging
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ env.DOO_GITHUB_TOKEN }}
          default_bump: patch

      - name: Set DISPATCH_TAG for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "DISPATCH_TAG=manual-$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      - name: Build doodba image
        id: build
        uses: docker/build-push-action@v6.18.0
        with:
          context: ./odoo
          file: ./odoo/Dockerfile
          build-args: |
            ODOO_VERSION=16.0
          tags: |
            ${{ env.TEST_TAG }}
          load: true
          no-cache: true #força rebuild do Doodba
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Testando a inicialização real do Odoo (baseado no padrão do Doodba CI)
      - name: Wait for Postgres
        run: |
          echo "Waiting for Postgres to be ready..."
          for i in {1..20}; do
            if docker run --rm --network host postgres:16-alpine pg_isready -h 127.0.0.1 -U odoo >/dev/null 2>&1; then
              echo "✅ Postgres is ready!"
              break
            fi
            echo "⏳ Waiting... ($i/20)"
            sleep 3
          done
      - name: Test Odoo startup
        run: |
          docker run --network host --rm \
            -e PGHOST=127.0.0.1 \
            -e PGUSER=odoo \
            -e PGPASSWORD=odoopassword \
            -e PGDATABASE=postgres \
            ${{ env.TEST_TAG }} \
            odoo --stop-after-init -i base

      - name: Push test image
        run: |
          VERSION=${{ steps.tagging.outputs.new_version }}
          docker tag ${{ env.TEST_TAG }} vanderleiromera/doodba16_odoo:$VERSION-ci-test
          docker tag ${{ env.TEST_TAG }} vanderleiromera/doodba16_odoo:$VERSION
          docker push vanderleiromera/doodba16_odoo:$VERSION-ci-test
          docker push vanderleiromera/doodba16_odoo:$VERSION
